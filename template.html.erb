<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
  <head>
    <title>Git-cal report</title>
    <script type="text/javascript" src="http://jqueryjs.googlecode.com/files/jquery-1.3.1.min.js"></script>
    <script type="text/javascript">
      /**
       * Returns the week number for this date. dowOffset is the day of week the week
       * "starts" on for your locale - it can be from 0 to 6. If dowOffset is 1 (Monday),
       * the week returned is the ISO 8601 week number.
       * @param int dowOffset
       * @return int
       */
      Date.prototype.getWeek = function (dowOffset) {
          /*getWeek() was developed by Nick Baicoianu at MeanFreePath: http://www.meanfreepath.com */

          dowOffset = typeof(dowOffset) == 'int' ? dowOffset : 0; //default dowOffset to zero
          var newYear = new Date(this.getFullYear(),0,1);
          var day = newYear.getDay() - dowOffset; //the day of week the year begins on
          day = (day >= 0 ? day : day + 7);
          var daynum = Math.floor((this.getTime() - newYear.getTime() -
                                   (this.getTimezoneOffset()-newYear.getTimezoneOffset())*60000)/86400000) + 1;
          var weeknum;
          //if the year starts before the middle of a week
          if(day < 4) {
              weeknum = Math.floor((daynum+day-1)/7) + 1;
              if(weeknum > 52) {
                  nYear = new Date(this.getFullYear() + 1,0,1);
                  nday = nYear.getDay() - dowOffset;
                  nday = nday >= 0 ? nday : nday + 7;
                  /*if the next year starts before the middle of
the week, it is week #1 of that year*/
                  weeknum = nday < 4 ? 1 : 53;
              }
          }
          else {
              weeknum = Math.floor((daynum+day-1)/7);
          }
          return weeknum;
      };

      Array.prototype.select = function(f) {
          ret = [];
          for (var i=0,il=this.length;i<il;++i) {
              if (f(this[i]) === true) {
                  ret.push(this[i]);
              }
          }
          return ret;
      }
logdata = [
      <%= log.map{|item|
                  "{author: \"" + item[:author] + "\", date: new Date(" +
                  item[:timestamp] + "), message: \"" + item[:message] + "\"}"
      }.join(",\n")%>
      ];

      $(document).ready(function() {
          var table = $("table.week");
          var now = new Date();
          var thisWeek = logdata.select(function(v) {
              return (now.getWeek(1) == v.date.getWeek(1));
          });
          for (var i=0,il=thisWeek.length;i<il;++i) {
              table.append(["<tr><td>",thisWeek[i].author,"</td><td>",
                            thisWeek[i].date,"</td><td>",
                            thisWeek[i].message,"</td></tr>"].join(""));
          }
      });
</script>
  </head>
  <body>
    <h1>Git-cal report</h1>
    <table>
    </table>
    <table class="week">
      <thead>
        <tr><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <!-- TODO: Neat stuff with jQuery... you know... -->
    <p><small>Generated by <a href="http://github.com/iiska/git-cal">git-cal</a></small></p>
  </body>
</html>